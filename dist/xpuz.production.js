(function(f){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=f()}else if(typeof define==="function"&&define.amd){define([],f)}else{var g;if(typeof window!=="undefined"){g=window}else if(typeof global!=="undefined"){g=global}else if(typeof self!=="undefined"){g=self}else{g=this}g.XPuz = f()}})(function(){var define,module,exports;return (function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
"use strict";var Puzzle=require("./lib/puzzle"),ImmutablePuzzle=require("./lib/immutable-puzzle");exports=module.exports={Parsers:{IPUZ:require("./parsers/ipuz"),PUZ:require("./parsers/puz"),JPZ:require("./parsers/jpz")},Puzzle:Puzzle,ImmutablePuzzle:ImmutablePuzzle,convertPuzzleToImmutablePuzzle:function(e){return new ImmutablePuzzle({grid:e.grid,clues:e.clues,userSolution:e.userSolution,info:e.info,extensions:e.extensions})},convertImmutablePuzzleToPuzzle:function(e){return new Puzzle({grid:e.grid.toJS(),clues:e.clues.toJS(),userSolution:e.userSolution.toJS(),info:e.info.toJS(),extensions:e.extensions.toJS()})}};

},{"./lib/immutable-puzzle":2,"./lib/puzzle":4,"./parsers/ipuz":5,"./parsers/jpz":6,"./parsers/puz":7}],2:[function(require,module,exports){
"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var _require=require("immutable"),List=_require.List,Map=_require.Map,Record=_require.Record,is=_require.is,Collection=_require.Collection,fromJS=_require.fromJS,PuzzleMixin=require("./puzzle-mixin"),infoSchema={title:"",author:"",publisher:"",copyright:"",difficulty:"",intro:""},PuzzleInfo=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return _inherits(t,Record(infoSchema,"PuzzleInfo")),t}(),schema={grid:List(),clues:Map({across:Map(),down:Map()}),userSolution:List(),info:new PuzzleInfo,extensions:Map()},ImmutablePuzzle=function(e){function t(e){var r=e.grid,o=e.clues,n=e.userSolution,i=e.info,u=e.extensions;_classCallCheck(this,t),i instanceof PuzzleInfo||(i=new PuzzleInfo(i));var s={info:i,grid:r=r?t.processGrid(fromJS(r)):List(),userSolution:n?fromJS(n):r.map(function(e){return e.map(function(e){return e.get("isBlockCell")?null:""})})};return o&&(s.clues=fromJS(o)),u&&(s.extensions=fromJS(u)),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,s))}return _inherits(t,Record(schema,"ImmutablePuzzle")),t}();PuzzleMixin({constructor:ImmutablePuzzle,equalityTest:is,getter:function(e,t){return e.getIn(t)},setter:function(e,t,r){return e.setIn(t,r instanceof Collection?r:fromJS(r))},sizeOf:function(e){return e.size}});var oldProcessGrid=ImmutablePuzzle.processGrid;ImmutablePuzzle.processGrid=function(e){return e.withMutations(function(e){return oldProcessGrid(e)})},exports=module.exports=ImmutablePuzzle;

},{"./puzzle-mixin":3,"immutable":undefined}],3:[function(require,module,exports){
"use strict";function _defineProperty(e,i,r){return i in e?Object.defineProperty(e,i,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[i]=r,e}function PuzzleMixin(e){function i(e){var i=e.grid,r=e.width,l=e.height,o=e.rowIndex,t=e.columnIndex,n={},u=s(i,[o,t,"clueNumber"]);if(void 0!==u&&((0===t||s(i,[o,t-1,"isBlockCell"]))&&t<r-1&&!s(i,[o,t+1,"isBlockCell"])?n.across=u:o<l-1&&!s(i,[o+1,t,"isBlockCell"])&&(n.down=u)),!n.across)if(0!==t||void 0===u||s(i,[o,t+1,"isBlockCell"]))for(var c=t;c>=0&&!s(i,[o,c,"isBlockCell"]);c--)c<r-1&&!s(i,[o,c+1,"isBlockCell"])&&(n.across=s(i,[o,c,"clueNumber"]));else n.across=u;if(!n.down)if(0!==o||void 0===u||s(i,[o+1,t,"isBlockCell"]))for(var a=o;a>=0&&!s(i,[a,t,"isBlockCell"]);a--)a<l-1&&!s(i,[a+1,t,"isBlockCell"])&&(n.down=s(i,[a,t,"clueNumber"]));else n.down=u;return n}function r(e){var i=e.grid,r=e.width,l=e.height,o=e.rowIndex,t=e.columnIndex;if(!s(i,[o,t,"isBlockCell"]))return!(0!==t&&!s(i,[o,t-1,"isBlockCell"])||!(t+1<r)||s(i,[o,t+1,"isBlockCell"]))||!(0!==o&&!s(i,[o-1,t,"isBlockCell"])||!(o+1<l)||s(i,[o+1,t,"isBlockCell"]))}var l,o=e.constructor,t=e.equalityTest,n=e.getter,s=void 0===n?get:n,u=e.setter,c=void 0===u?set:u,a=e.sizeOf,d=void 0===a?size:a,f=o.name;Object.defineProperties(o.prototype,(l={equals:{writable:!0,configurable:!0,value:function(e){return e instanceof o&&(t(this.grid,e.grid)&&t(this.clues,e.clues)&&t(this.userSolution,e.userSolution)&&t(this.info,e.info)&&t(this.extensions,e.extensions))}},hashCode:{writable:!0,configurable:!0,value:function(){return hashIt(this)}},toString:{writable:!0,configurable:!0,value:function(){return f}}},_defineProperty(l,Symbol.toStringTag,{configurable:!0,get:function(){return f}}),_defineProperty(l,"updateGrid",{writable:!0,configurable:!0,value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.grid;return c(this,["grid"],o.processGrid(e))}}),_defineProperty(l,"updateCell",{writable:!0,configurable:!0,value:function(e,i,r){var l=c(this.grid,[i,e],r);return this.updateGrid(l)}}),l)),Object.defineProperties(o,{processGrid:{writable:!0,enumerable:!0,value:function(e){for(var l=d(e),o=d(s(e,[0])),t=0,n=0;n<l;n++)for(var u=0;u<o;u++)if(!s(e,[n,u,"isBlockCell"])){var a={grid:e,width:o,height:l,rowIndex:n,columnIndex:u},f=r(a)?++t:void 0;c(e,[n,u,"clueNumber"],f),c(e,[n,u,"containingClues"],i(a))}return e}}})}var hashIt=require("hash-it"),get=require("lodash/get"),set=require("lodash/set"),size=require("lodash/size");exports=module.exports=PuzzleMixin;

},{"hash-it":undefined,"lodash/get":undefined,"lodash/set":undefined,"lodash/size":undefined}],4:[function(require,module,exports){
"use strict";function _classCallCheck(i,n){if(!(i instanceof n))throw new TypeError("Cannot call a class as a function")}var reduce=require("lodash/reduce"),isEqual=require("lodash/isEqual"),PuzzleMixin=require("./puzzle-mixin"),Puzzle=function i(n){var e=this,t=n.grid,s=n.clues,u=n.userSolution,r=n.info,o=n.extensions;_classCallCheck(this,i),this.toJSON=function(){return{grid:e.grid,clues:e.clues,userSolution:e.userSolution,info:e.info,extensions:e.extensions}},this.clone=function(){return new i({grid:e.grid.map(function(i){return i.map(function(i){return Object.assign({},i)})}),clues:{across:reduce(e.clues.across,function(i,n,e){return i[e]=n,i},{}),down:reduce(e.clues.down,function(i,n,e){return i[e]=n,i},{})},userSolution:e.userSolution.map(function(i){return i.map(function(i){return i})}),info:Object.assign({},e.info),extensions:JSON.parse(JSON.stringify(e.extensions))})},this.grid=i.processGrid(t||[]),this.clues=s||{across:{},down:{}},r=r||{},this.info={title:r.title||"",author:r.author||"",copyright:r.copyright||"",publisher:r.publisher||"",difficulty:r.difficulty||"",intro:r.intro||""},this.userSolution=u||t.map(function(i){return i.map(function(i){return i.isBlockCell?null:""})}),this.extensions=o||{}};PuzzleMixin({constructor:Puzzle,equalityTest:isEqual}),exports=module.exports=Puzzle;

},{"./puzzle-mixin":3,"lodash/isEqual":undefined,"lodash/reduce":undefined}],5:[function(require,module,exports){
"use strict";function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function _toConsumableArray(e){if(Array.isArray(e)){for(var r=0,n=Array(e.length);r<e.length;r++)n[r]=e[r];return n}return Array.from(e)}function _checkDimensions(e){var r=[],n=max(e.puzzle,"length").length,i=e.puzzle.length;return n>e.dimensions.width&&r.push("Too many puzzle cells ("+n+") for puzzle width ("+e.dimensions.width+")"),i>e.dimensions.height&&r.push("Too many puzzle cells ("+i+") for puzzle height ("+e.dimensions.height+")"),r}function _getClueNumber(e){return isObject(e)?e.cell:e}function _addClue(e,r){return e[r[0]]=r[1],e}function _convertPuzzle(e){return new Puzzle({info:{title:e.title,author:e.author,copyright:e.copyright,publisher:e.publisher,difficulty:e.difficulty,intro:e.intro},grid:e.puzzle.map(function(e){return e.map(function(e){return e===BLOCK_VALUE?{isBlockCell:!0}:{clueNumber:_getClueNumber(e),backgroundShape:get(e,"style.shapebg")}})}),clues:{across:reduce(e.clues.across,_addClue,{}),down:reduce(e.clues.down,_addClue,{})}})}function _validatePuzzle(e){var r=[];return e.dimensions||r.push("Puzzle is missing 'dimensions' key"),e.puzzle?r.push.apply(r,_toConsumableArray(_checkDimensions(e))):r.push("Puzzle is missing 'puzzle' key"),0===r.length?void 0:r}var _createClass=function(){function e(e,r){for(var n=0;n<r.length;n++){var i=r[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(r,n,i){return n&&e(r.prototype,n),i&&e(r,i),r}}(),Promise=require("bluebird"),fs=require("fs"),readFile=fs.readFile?Promise.promisify(fs.readFile):function(){},max=require("lodash/max"),get=require("lodash/get"),isObject=require("lodash/isObject"),isString=require("lodash/isString"),reduce=require("lodash/reduce"),Puzzle=require("../lib/puzzle"),BLOCK_VALUE="#",IPUZParser=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"parse",value:function(e){var r=void 0;if(isString(e))r=readFile(e).then(function(e){return JSON.parse(e.toString())}).catch(function(r){throw new Error("Unable to read IPUZ puzzle from file "+e+": "+r.message)});else{if(!isObject(e))return Promise.reject(new Error("parse() expects either a path string or an object"));r=Promise.resolve(e)}return r.then(function(e){var r=_validatePuzzle(e);if(void 0!==r)throw new Error("Invalid puzzle:\n\t"+r.join("\n\t"));return _convertPuzzle(e)})}}]),e}();exports=module.exports=IPUZParser;

},{"../lib/puzzle":4,"bluebird":undefined,"fs":undefined,"lodash/get":undefined,"lodash/isObject":undefined,"lodash/isString":undefined,"lodash/max":undefined,"lodash/reduce":undefined}],6:[function(require,module,exports){
"use strict";function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,r){for(var n=0;n<r.length;n++){var t=r[n];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}return function(r,n,t){return n&&e(r.prototype,n),t&&e(r,t),r}}(),isString=require("lodash/isString"),isObject=require("lodash/isObject"),Promise=require("bluebird"),fs=require("fs"),readFile=fs.readFile?Promise.promisify(fs.readFile):function(){},Puzzle=require("../lib/puzzle"),JPZParser=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"parse",value:function(e){return isString(e)?readFile(e).then(function(e){return new Puzzle(e.toString())}).catch(function(r){throw new Error("Unable to read JPZ puzzle from file "+e+": "+r.message)}):isObject(e)?Promise.resolve(new Puzzle(e)):Promise.reject(new Error("parse() expects either a path string or an object"))}}]),e}();exports=module.exports=JPZParser;

},{"../lib/puzzle":4,"bluebird":undefined,"fs":undefined,"lodash/isObject":undefined,"lodash/isString":undefined}],7:[function(require,module,exports){
(function (Buffer){
"use strict";function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function _toConsumableArray(e){if(Array.isArray(e)){for(var n=0,r=Array(e.length);n<e.length;n++)r[n]=e[n];return r}return Array.from(e)}function _doChecksum(e,n){for(var r=0;r<e.length;r++){var t=1&n;n>>=1,t&&(n|=32768),n=n+e.readUInt8(r)&65535}return n}function _readHeader(e,n){var r={};if(r.globalChecksum=e._readUInt16(),e._seek("ACROSS&DOWN\0".length,{current:!0}),r.headerChecksum=e._readUInt16(),r.magicChecksum=e._readValues(MAGIC_CHECKSUM_BYTE_LENGTH),r.version=e._readString(),r.unknown1=e._readValues(UNKNOWN1_BYTE_LENGTH),r.scrambledChecksum=e._readUInt16(),r.unknown2=e._readValues(UNKNOWN2_BYTE_LENGTH),r.width=e._readUInt8(),r.height=e._readUInt8(),r.numberOfClues=e._readUInt16(),r.puzzleType=e._readUInt16(),r.solutionState=e._readUInt16(),r.solutionState===SOLUTION_STATE.Locked&&!n.solutionKey)throw new Error("Puzzle solution is locked and no solutionKey option was provided");return r}function _processExtension(e){if("GRBS"===e.name&&(e.board=map(e.data,function(e){return 0===e?null:e-1})),"RTBL"===e.name&&(e.rebus_solutions=reduce(iconv.decode(e.data,PUZReader.ENCODING).split(";"),function(e,n){var r=n.split(":");return r[0]=parseInt(r[0],10),e[r[0]]=r[1],e},{})),"LTIM"===e.name){var n=iconv.decode(e.data,PUZReader.ENCODING).split(",");e.timing={elapsed:parseInt(n[0],10),running:"0"===n[1]}}return"GEXT"===e.name&&(e.cell_states=map(e.data,function(e){return{PreviouslyIncorrect:!!(e&CELL_STATES.PreviouslyIncorrect),CurrentlyIncorrect:!!(e&CELL_STATES.CurrentlyIncorrect),AnswerGiven:!!(e&CELL_STATES.AnswerGiven),Circled:!!(e&CELL_STATES.Circled)}})),"RUSR"===e.name&&(e.user_rebus_entries=map(iconv.decode(e.data,PUZReader.ENCODING).split("\0"),function(e){return""===e?null:e})),e}function _readExtension(e){var n={};n.name=e._readString(EXTENSION_NAME_LENGTH);var r=e._readUInt16();return n.checksum=e._readUInt16(),n.data=e._readValues(r+1),n.data=n.data.slice(0,-1),_processExtension(n)}function _parseEnd(e,n){if(e.size()-e.tell()>=EXTENSION_HEADER_LENGTH){var r=_readExtension(e);n.extensions=n.extensions||{},n.extensions[r.name]=r,delete r.name,_parseEnd(e,n)}}function _parseExtensions(e,n){var r={};_parseEnd(e,r),get(r,"extensions.GRBS")&&each(flatten(n.grid),function(e,n){var t=e;if(null!==r.extensions.GRBS.board[n]){var o=r.extensions.RTBL.rebus_solutions[r.extensions.GRBS.board[n]];t.solution=o}}),get(r,"extensions.RUSR")&&r.extensions.RUSR.user_rebus_entries.forEach(function(e,r){if(null!==e){var t=Math.floor(r/n.header.width),o=r%n.header.width;n.solution[t][o]=e}}),n._extensions=r.extensions,n.timing=get(r,"extensions.LTIM.timing")}function _readClues(e,n){for(var r=[],t=0;t<n;t++)r.push(e._readString());return r}function _generateGridAndClues(e,n){function r(n,r){return e[r][n]===BLOCK_CELL_VALUE}for(var t={across:{},down:{}},o=[],i=e[0].length,u=e.length,a=0,s=0,c=0;c<u;c++){for(var l=[],d=0;d<i;d++){var _={};if(r(d,c))_.isBlockCell=!0;else{_.solution=e[c][d];var E=!1,h=!1;(0===d||r(d-1,c))&&d+1<i&&!r(d+1,c)&&(h=!0),(0===c||r(d,c-1))&&c+1<u&&!r(d,c+1)&&(E=!0),(h||E)&&(_.clueNumber=++a),h&&(t.across[a]=n[s++]),E&&(t.down[a]=n[s++])}l.push(_)}o.push(l)}return{grid:o,clues:t}}function _pluckSolutions(e){return e.map(function(e){return e.map(function(e){return e.isBlockCell?BLOCK_CELL_VALUE:null===e.solution?" ":e.solution})})}function _flattenSolution(e){return flatten(e).map(function(e){return null===e?BLOCK_CELL_VALUE:""===e?"-":e[0]}).join("")}function _unflattenSolution(e,n){return chunk(e.split(""),n).map(function(e){return e.map(function(e){return"-"===e?"":e})})}function _textChecksum(e,n){return e.title&&(n=_doChecksum(iconv.encode(e.title+"\0",PUZReader.ENCODING),n)),e.author&&(n=_doChecksum(iconv.encode(e.author+"\0",PUZReader.ENCODING),n)),e.copyright&&(n=_doChecksum(iconv.encode(e.copyright+"\0",PUZReader.ENCODING),n)),e.clueList.forEach(function(e){e&&(n=_doChecksum(iconv.encode(e,PUZReader.ENCODING),n))}),e.notes&&(n=_doChecksum(iconv.encode(e.notes+"\0",PUZReader.ENCODING),n)),n}function _headerChecksum(e,n){void 0===n&&(n=0);var r=new Buffer(HEADER_CHECKSUM_BYTE_LENGTH);return r.writeUInt8(e.header.width,0),r.writeUInt8(e.header.height,1),r.writeUInt16LE(e.header.numberOfClues,2),r.writeUInt16LE(e.header.puzzleType,4),r.writeUInt16LE(e.header.solutionState,6),_doChecksum(r,n)}function _globalChecksum(e,n){var r=void 0===n?_headerChecksum(e):n,t=iconv.encode(e.answer,PUZReader.ENCODING);return r=_doChecksum(t,r),t=iconv.encode(e.solution,PUZReader.ENCODING),r=_doChecksum(t,r),r=_textChecksum(e,r)}function _magicChecksum(e){var n=_headerChecksum(e),r=_doChecksum(iconv.encode(e.answer,PUZReader.ENCODING)),t=_doChecksum(iconv.encode(e.solution,PUZReader.ENCODING)),o=_textChecksum(e);return new Buffer(["ICHEATED".charCodeAt(0)^255&n,"ICHEATED".charCodeAt(1)^255&r,"ICHEATED".charCodeAt(2)^255&t,"ICHEATED".charCodeAt(3)^255&o,"ICHEATED".charCodeAt(4)^(65280&n)>>8,"ICHEATED".charCodeAt(5)^(65280&r)>>8,"ICHEATED".charCodeAt(6)^(65280&t)>>8,"ICHEATED".charCodeAt(7)^(65280&o)>>8])}function _transposeGrid(e,n,r){var t=e.match(new RegExp(".{1,"+n+"}","g"));return range(n).map(function(e){return range(r).map(function(n){return t[n][e]}).join("")}).join("")}function _restoreSolution(e,n){return n=n.split(""),e.split("").reduce(function(e,r){return r===BLOCK_CELL_VALUE?e.push(r):e.push(n.shift()),e},[]).join("")}function _shift(e,n){return e.split("").map(function(e,r){var t=(ATOZ.indexOf(e)+Number(n[r%n.length]))%ATOZ.length;return t<0&&(t=ATOZ.length+t),ATOZ[t]}).join("")}function _unshift(e,n){return _shift(e,map(n,function(e){return-e}))}function _everyOther(e){return e.split("").reduce(function(e,n,r){return r%2==0&&e.push(n),e},[]).join("")}function _unshuffle(e){return _everyOther(e.substring(1))+_everyOther(e)}function _unscrambleString(e,n){var r=e.length;return reverse(padStart(n,PUZZLE_KEY_LENGTH,"0").split("")).forEach(function(t){e=_unshuffle(e),e=e.substring(r-t)+e.substring(0,r-t),e=_unshift(e,n)}),e}function _shuffle(e){var n=Math.floor(e.length/2);return zip(e.substring(n).split(""),e.substring(0,n).split("")).reduce(function(e,n){return void 0===n[0]||void 0===n[1]?e:(e.push(n[0]+n[1]),e)},[]).join("")+(e.length%2?e[e.length-1]:"")}function _scrambleString(e,n){return each(padStart(n,PUZZLE_KEY_LENGTH,"0"),function(r){e=_shift(e,n),e=e.substring(r)+e.substring(0,r),e=_shuffle(e)}),e}function _scrambledChecksum(e,n,r){var t=_transposeGrid(_flattenSolution(e),n,r).replace(BLOCK_CELL_VALUE_REGEX,"");return _doChecksum(iconv.encode(t,PUZReader.ENCODING))}function _validateChecksums(e){var n=_headerChecksum(e),r={header:n,global:_globalChecksum(e,n),magic:_magicChecksum(e)},t=[];return r.header!==e.header.headerChecksum&&t.push("header checksums do not match"),r.global!==e.header.globalChecksum&&t.push("global checksums do not match"),r.magic.equals(e.header.magicChecksum)||t.push("magic checksums do not match"),each(e._extensions,function(e,n){e.checksum!==_doChecksum(e.data)&&t.push("checksum for extension "+n+" does not match")}),t}function _scrambleSolution(e,n){var r=e.length,t=e[0].length,o=flatten(_flattenSolution(e)).join(""),i=_transposeGrid(o,t,r);return o=_transposeGrid(_restoreSolution(i,_scrambleString(i.replace(BLOCK_CELL_VALUE_REGEX,""),n)),r,t),chunk(o.split(""),t)}function _unscrambleSolution(e,n){var r=_transposeGrid(e.answer,e.header.width,e.header.height),t=_transposeGrid(_restoreSolution(r,_unscrambleString(r.replace(BLOCK_CELL_VALUE_REGEX,""),n)),e.header.height,e.header.width);if(t===e.answer)throw new Error("Unscrambled solution is the same as the scrambled solution; incorrect key?");return t}function _writeHeader(e,n){var r=new Buffer(CHECKSUM_BUFFER_LENGTH);r.writeUInt16LE(_globalChecksum(e));var t=new Buffer(CHECKSUM_BUFFER_LENGTH);t.writeUInt16LE(_headerChecksum(e));var o=_magicChecksum(e),i=new Buffer(CHECKSUM_BUFFER_LENGTH);get(n,"scrambled")?i.writeUInt16LE(_scrambledChecksum(e.unscrambledAnswer,e.header.width,e.header.height)):i.fill(0);var u=new Buffer(NUMBER_OF_CLUES_BUFFER_LENGTH);u.writeUInt16LE(e.header.numberOfClues);var a=new Buffer(PUZZLE_TYPE_BUFFER_LENGTH);a.writeUInt16LE(e.header.puzzleType);var s=new Buffer(SOLUTION_STATE_BUFFER_LENGTH);return s.writeUInt16LE(e.header.solutionState),Buffer.concat([r,iconv.encode("ACROSS&DOWN\0",PUZReader.ENCODING),t,o,iconv.encode(get(n,"version","1.3")+"\0",PUZReader.ENCODING),new Buffer([0,0]),i,new Buffer(UNKNOWN2_BYTE_LENGTH).fill(0),new Buffer([e.header.width]),new Buffer([e.header.height]),u,a,s],HEADER_BUFFER_LENGTH)}function _writeExtension(e,n){var r=new Buffer(EXTENSION_LENGTH_BUFFER_LENGTH);r.writeUInt16LE(e.length);var t=new Buffer(CHECKSUM_BUFFER_LENGTH);return t.writeUInt16LE(_doChecksum(e)),Buffer.concat([iconv.encode(n,PUZReader.ENCODING),r,t,e,new Buffer([0])],EXTENSION_NAME_LENGTH+EXTENSION_LENGTH_BUFFER_LENGTH+CHECKSUM_BUFFER_LENGTH+e.length+1)}function _writeGRBS(e,n){return _writeExtension(new Buffer(e.map(function(e,r){var t=findKey(n,function(e){return e.cells.includes(r)});return void 0===t?0:parseInt(t,10)+1})),"GRBS")}function _writeRTBL(e){return _writeExtension(iconv.encode(Object.keys(e).map(function(n){return padStart(n,RTBL_KEY_PADDING_WIDTH," ")+":"+e[n].solution+";"}).join(""),PUZReader.ENCODING),"RTBL")}function _writeRUSR(e){return _writeExtension(iconv.encode(e.map(function(e){return e.length>1?e+"\0":"\0"}).join(""),PUZReader.ENCODING),"RUSR")}function _writeLTIM(e){return _writeExtension(iconv.encode(e.elapsed+","+(e.running?"1":"0"),PUZReader.ENCODING),"LTIM")}function _writeRebus(e,n,r){var t=0,o=flatten(e).reduce(function(e,n,r){if(n&&n.length>1){var o=findKey(e,{solution:n});void 0===o?e[++t]={solution:n,cells:[r]}:e[o].cells.push(r)}return e},{}),i=_writeGRBS(e,o),u=_writeRTBL(o),a=_writeRUSR(n),s=[i,u,a],c=i.length+u.length+a.length;if(r.timing){var l=_writeLTIM(r.timing);s.push(l),c+=l.length}return Buffer.concat(s,c)}function _parsePuzzle(e,n){var r={},t=new PUZReader(e);r.header=_readHeader(t,n);var o=r.header.width*r.header.height;r.answer=t._readString(o),r.header.solutionState===SOLUTION_STATE.Locked?r.unscrambledAnswer=_unscrambleSolution({header:r.header,answer:r.answer},n.solutionKey):r.unscrambledAnswer=r.answer,r.solution=t._readString(o),r.title=t._readString(),r.author=t._readString(),r.copyright=t._readString(),r.clueList=_readClues(t,r.header.numberOfClues);var i=_generateGridAndClues(_unflattenSolution(r.unscrambledAnswer,r.header.width),r.clueList);return r.grid=i.grid,r.clues=i.clues,r.notes=t._readString(),_parseExtensions(t,r),r}function validatePuzzle(e){var n=_validateChecksums(e),r=[];return n&&r.push.apply(r,_toConsumableArray(n)),0===r.length?void 0:r}function _getPuzzleData(e,n){return new Promise(function(r,t){try{var o=_parsePuzzle(e,n),i=validatePuzzle(o);void 0!==i?t("Invalid puzzle:\n\t"+i.join("\n\t")):r({info:{title:o.title||void 0,author:o.author||void 0,copyright:o.copyright||void 0,intro:o.notes||void 0},grid:o.grid,clues:o.clues,userSolution:_unflattenSolution(o.solution,o.header.width),extensions:{timing:o.timing}})}catch(e){t(e)}})}var _createClass=function(){function e(e,n){for(var r=0;r<n.length;r++){var t=n[r];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}return function(n,r,t){return r&&e(n.prototype,r),t&&e(n,t),n}}(),map=require("lodash/map"),get=require("lodash/get"),range=require("lodash/range"),reverse=require("lodash/reverse"),zip=require("lodash/zip"),each=require("lodash/each"),reduce=require("lodash/reduce"),flatten=require("lodash/flatten"),padStart=require("lodash/padStart"),chunk=require("lodash/chunk"),findKey=require("lodash/findKey"),compact=require("lodash/compact"),size=require("lodash/size"),iconv=require("iconv-lite"),PUZReader=require("./puz/puz-reader"),Puzzle=require("../lib/puzzle"),ImmutablePuzzle=require("../lib/immutable-puzzle"),BLOCK_CELL_VALUE=".",BLOCK_CELL_VALUE_REGEX=/\./g,EXTENSION_HEADER_LENGTH=8,HEADER_CHECKSUM_BYTE_LENGTH=8,MAGIC_CHECKSUM_BYTE_LENGTH=8,UNKNOWN1_BYTE_LENGTH=2,UNKNOWN2_BYTE_LENGTH=12,CHECKSUM_BUFFER_LENGTH=2,NUMBER_OF_CLUES_BUFFER_LENGTH=2,PUZZLE_TYPE_BUFFER_LENGTH=2,SOLUTION_STATE_BUFFER_LENGTH=2,HEADER_BUFFER_LENGTH=52,EXTENSION_LENGTH_BUFFER_LENGTH=2,EXTENSION_NAME_LENGTH=4,PUZZLE_KEY_LENGTH=4,RTBL_KEY_PADDING_WIDTH=2,PUZZLE_TYPE={Normal:1,Diagramless:1025},SOLUTION_STATE={Unlocked:0,Locked:4},CELL_STATES={PreviouslyIncorrect:16,CurrentlyIncorrect:32,AnswerGiven:64,Circled:128},ATOZ="ABCDEFGHIJKLMNOPQRSTUVWXYZ",MINIMUM_KEY_VALUE=1e3,MAXIMUM_KEY_VALUE=9999,PUZParser=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"parse",value:function(e,n){return n=n||{},_getPuzzleData(e,n).then(function(e){return new Puzzle(e)})}},{key:"parseImmutable",value:function(e,n){return n=n||{},_getPuzzleData(e,n).then(function(e){return new ImmutablePuzzle(e)})}},{key:"generate",value:function(e,n){e=e.toJSON();var r=size(e.clues.across)+size(e.clues.down),t=PUZZLE_TYPE.Normal,o=SOLUTION_STATE.Unlocked;n=n||{};var i=e.grid.length,u=e.grid[0].length,a=e.info.intro||"",s=_pluckSolutions(e.grid),c=void 0;if(n.scrambled){if(!n.solutionKey||Number(n.solutionKey)<MINIMUM_KEY_VALUE||Number(n.solutionKey)>MAXIMUM_KEY_VALUE)throw new Error("Must specify a solution key that is an integer >= 1000 and <= 9999; was "+n.solutionKey);c=s,s=_scrambleSolution(s,n.solutionKey),o=SOLUTION_STATE.Locked}var l=flatten(s),d=flatten(c||s),_=e.userSolution.map(function(e){return e.map(function(e){return null===e?BLOCK_CELL_VALUE:""===e?"-":e})}),E=flatten(_),h=compact(flatten(e.grid).map(function(e){return e.clueNumber})).reduce(function(n,r){return void 0!==e.clues.across[r]&&n.push(e.clues.across[r]),void 0!==e.clues.down[r]&&n.push(e.clues.down[r]),n},[]),f=_writeHeader({header:{width:u,height:i,numberOfClues:r,puzzleType:t,solutionState:o},answer:_flattenSolution(l),unscrambledAnswer:_flattenSolution(d),solution:_flattenSolution(_),title:e.info.title,author:e.info.author,copyright:e.info.copyright,clueList:h,notes:a},n),C=iconv.encode(_flattenSolution(s),PUZReader.ENCODING),m=iconv.encode(E.map(function(e){return e[0]}).join(""),PUZReader.ENCODING),N=iconv.encode((e.info.title||"")+"\0",PUZReader.ENCODING),L=iconv.encode((e.info.author||"")+"\0",PUZReader.ENCODING),U=iconv.encode((e.info.copyright||"")+"\0",PUZReader.ENCODING),g=iconv.encode(h.join("\0")+"\0",PUZReader.ENCODING),T=iconv.encode(a+"\0",PUZReader.ENCODING),p=[f,C,m,N,L,U,g,T],v=f.length+C.length+m.length+N.length+L.length+U.length+g.length+T.length;if(d.some(function(e){return e.length>1})){var S=_writeRebus(d,E,e.extensions||{});p.push(S),v+=S.length}return Buffer.concat(p,v)}}]),e}();exports=module.exports=PUZParser;

}).call(this,require("buffer").Buffer)
},{"../lib/immutable-puzzle":2,"../lib/puzzle":4,"./puz/puz-reader":8,"buffer":undefined,"iconv-lite":undefined,"lodash/chunk":undefined,"lodash/compact":undefined,"lodash/each":undefined,"lodash/findKey":undefined,"lodash/flatten":undefined,"lodash/get":undefined,"lodash/map":undefined,"lodash/padStart":undefined,"lodash/range":undefined,"lodash/reduce":undefined,"lodash/reverse":undefined,"lodash/size":undefined,"lodash/zip":undefined}],8:[function(require,module,exports){
(function (Buffer){
"use strict";function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}var isString=require("lodash/isString"),fs=require("fs"),BufferReader=require("buffer-reader"),iconv=require("iconv-lite"),ENCODING="ISO-8859-1",INT16_BYTE_COUNT=2,INT32_BYTE_COUNT=4,DEFAULT_STRING_BUFFER_LENGTH=20,PUZReader=function e(r){var t=this;_classCallCheck(this,e),this._readValues=function(e){return t._bufferReader.nextBuffer(e)},this._seek=function(e,r){return(r=r||{start:!0}).start?t._bufferReader.seek(e):r.current&&t._bufferReader.move(e),t},this._readUInt8=function(){return t._readValues(1).readUInt8(0)},this._readUInt16=function(){return t._readValues(INT16_BYTE_COUNT).readUInt16LE(0)},this._readUInt32=function(){return t._readValues(INT32_BYTE_COUNT).readUInt32LE(0)},this._readString=function(e){var r=e||DEFAULT_STRING_BUFFER_LENGTH,n=t.size(),i=t.tell();if(i+r>n&&(r=n-i),0===r)return"";var a=t._readValues(r),f=iconv.decode(a,ENCODING);if(e)return f;var u=f.indexOf("\0");if(u>=0){var s=u-f.length;s<0&&(t._seek(s+1,{current:!0}),f=f.substring(0,u))}else f+=t._readString();return f},this.size=function(){return t._bufferSize},this.tell=function(){return t._bufferReader.tell()};var n=void 0;isString(r)?n=fs.readFileSync(r):r instanceof Buffer?n=r:r instanceof ArrayBuffer&&(n=new Buffer(new Uint8Array(r))),this._bufferReader=new BufferReader(n),this._bufferSize=n.length};PUZReader.ENCODING=ENCODING,module.exports=exports=PUZReader;

}).call(this,require("buffer").Buffer)
},{"buffer":undefined,"buffer-reader":undefined,"fs":undefined,"iconv-lite":undefined,"lodash/isString":undefined}]},{},[1])(1)
});